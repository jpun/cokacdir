# PR #12 Review — Telegram 봇 대화형 Setup Wizard (`--setup`) 및 토큰 자동 로드

## 개요

- **변경 파일**: 2개 (신규 1개, 수정 1개)
- **추가된 코드**: 325줄 (신규 `setup.rs`), main.rs에 ~19줄 순증
- **변경 성격**: 새로운 CLI 기능 추가 (`--setup` 마법사 + `--ccserver` 토큰 자동 로드)
- **PR base와 현재 main 비교**: main이 상당히 진화함 (cron 스케줄링 시스템 추가, ismcptool/addmcptool 삭제, sendfile JSON 포맷 변환 등). 그러나 PR 변경 영역과의 직접 충돌은 극히 제한적.

---

## 변경 파일 목록

| 파일 | 상태 | 설명 |
|------|------|------|
| `src/setup.rs` | **신규** (325줄) | 대화형 Telegram 봇 초기 설정 마법사 + 저장된 토큰 로드 |
| `src/main.rs` | **수정** (4개소) | `mod setup` 선언, `--setup` CLI 핸들러, `--ccserver` 토큰 fallback, help 텍스트 수정 |

---

## 핵심 변경사항 상세

### 1. `src/setup.rs` — 대화형 Setup Wizard (신규 파일, 325줄)

완전히 새로운 파일. Telegram 봇 토큰을 대화형으로 설정하고 `~/.cokacdir/config.json`에 저장하는 기능.

#### 구조

```
setup.rs
├── i18n strings (Lang enum, Strings struct, KO/EN 상수)
├── helpers (read_line_trimmed, find_in_path, get_cmd_output, config_path)
├── setup steps (select_language, validate_token_format, get_telegram_token,
│                get_working_directory, save_setup_config,
│                check_git_installed, check_gh_installed, print_success_message)
└── public API (run_setup, load_saved_token)
```

#### i18n 시스템 (1~82행)

한국어/영어 2개 언어 지원. `Strings` struct에 18개 문자열 필드:

```rust
#[derive(Clone, Copy)]
pub enum Lang { Ko, En }

struct Strings {
    header, lang_prompt, token_prompt, token_invalid_format,
    token_validation_skip, token_saved, workdir_prompt, workdir_default,
    workdir_not_dir, git_ok, git_missing, git_install_hint,
    gh_ok, gh_missing, gh_install_hint, complete, hint_run, hint_setup,
}
```

- `const KO: Strings` — 한국어 문자열
- `const EN: Strings` — 영어 문자열
- `fn s(lang: Lang) -> &'static Strings` — 언어별 문자열 참조 반환

#### 헬퍼 함수 (84~118행)

| 함수 | 역할 |
|------|------|
| `read_line_trimmed()` | stdin에서 한 줄 읽어 trim |
| `find_in_path(name)` | PATH에서 실행 파일 존재 여부 확인 |
| `get_cmd_output(name, args)` | 명령 실행 후 첫 줄 출력 반환 |
| `config_path()` | `~/.cokacdir/config.json` 경로 반환 |

#### Setup 단계별 함수 (120~276행)

**Step 1: 언어 선택 (`select_language`, 122~131행)**
```
Select language (1=Korean, 2=English) [default: 2]:
```
- 입력 "1" → 한국어, 그 외 → 영어

**Step 2: 토큰 입력 및 검증 (`get_telegram_token`, 148~176행)**
- 최대 3회 시도
- `validate_token_format()`: `<숫자>:<영숫자/_ / - , 10자 이상>` 형식 체크
- 3회 실패 시 Err 반환 (프로그램 종료)

**Step 3: 작업 디렉토리 (`get_working_directory`, 178~196행)**
- 기본값: 홈 디렉토리
- 입력된 경로가 디렉토리가 아니면 홈 디렉토리로 fallback

**Step 4: 설정 저장 (`save_setup_config`, 198~237행)**
- `~/.cokacdir/config.json`에 JSON 저장:
  ```json
  {
    "telegram_token": "123456:ABC...",
    "language": "ko",
    "working_directory": "/home/user"
  }
  ```
- 디렉토리: `0o700`, 파일: `0o600` 퍼미션 (Unix)

**Step 5: 환경 확인 (`check_git_installed`, `check_gh_installed`, 239~259행)**
- git, gh(GitHub CLI) 설치 여부 확인 및 버전 출력
- 미설치 시 설치 URL 안내

**Step 6: 완료 메시지 (`print_success_message`, 261~276행)**
```
──────────────────────────────────────────────────
  Setup complete!

  Start the bot:
    cokacdir --ccserver

  Run setup again:
    cokacdir --setup

  Working directory: /home/user
──────────────────────────────────────────────────
```

#### Public API (278~325행)

| 함수 | 시그니처 | 역할 |
|------|----------|------|
| `run_setup()` | `-> Result<(), Box<dyn std::error::Error>>` | 위 6단계 전체 실행 |
| `load_saved_token()` | `-> Option<String>` | `~/.cokacdir/config.json`에서 `telegram_token` 읽어 반환 |

---

### 2. `src/main.rs` — 변경 4개소

#### 변경 A: `mod setup;` 선언 추가 (6행 뒤)

```rust
// before:
mod enc;
          // ← 빈 줄

// after:
mod enc;
mod setup;
          // ← 빈 줄
```

#### 변경 B: `print_help()` 수정 (43행 부근)

```rust
// before (PR base):
println!("    --ccserver <TOKEN>...   Start Telegram bot server(s)");

// after:
println!("    --setup                 Run interactive Telegram bot setup wizard");
println!("    --ccserver [TOKEN]...   Start Telegram bot server(s) (token optional if --setup was run)");
```

핵심 변화: `<TOKEN>` (필수) → `[TOKEN]` (선택적) 으로 표기 변경, `--setup` 옵션 추가.

#### 변경 C: `--setup` CLI 핸들러 추가 (`--base64` 와 `--ccserver` 사이)

```rust
"--setup" => {
    if let Err(e) = setup::run_setup() {
        eprintln!("Setup failed: {}", e);
        std::process::exit(1);
    }
    return Ok(());
}
```

#### 변경 D: `--ccserver` 토큰 로드 fallback

```rust
// before:
"--ccserver" => {
    let tokens: Vec<String> = args[i + 1..].iter()
        .filter(|a| !a.starts_with('-'))
        .cloned()
        .collect();
    if tokens.is_empty() {
        eprintln!("Error: --ccserver requires at least one token argument");
        eprintln!("Usage: cokacdir --ccserver <TOKEN> [TOKEN2] ...");
        return Ok(());
    }
    handle_ccserver(tokens);
    return Ok(());
}

// after:
"--ccserver" => {
    let mut tokens: Vec<String> = if i + 1 < args.len() {
        args[i + 1..].iter()
            .filter(|a| !a.starts_with('-'))
            .cloned()
            .collect()
    } else {
        Vec::new()
    };
    // If no tokens provided via CLI, try loading from config
    if tokens.is_empty() {
        if let Some(saved_token) = setup::load_saved_token() {
            tokens.push(saved_token);
        } else {
            eprintln!("Error: --ccserver requires at least one token argument");
            eprintln!("Usage: cokacdir --ccserver <TOKEN> [TOKEN2] ...");
            eprintln!("       or run 'cokacdir --setup' to configure a token");
            return Ok(());
        }
    }
    handle_ccserver(tokens);
    return Ok(());
}
```

핵심 변화:
1. `tokens`가 `let` → `let mut`로 변경
2. 토큰이 비어있으면 `setup::load_saved_token()`으로 저장된 토큰 시도
3. 그래도 없으면 에러 메시지에 `--setup` 안내 추가
4. `i + 1 < args.len()` 경계 검사 추가 (기존 코드는 `--ccserver`가 마지막 인자일 때 빈 슬라이스를 만들어도 문제없지만, 이 PR은 더 명시적으로 처리)

---

## PR Base와 현재 Main의 차이 분석

PR 기여자가 작업한 base 버전과 현재 main 사이에는 상당한 차이가 있습니다 (diff ~633줄).

### Main에서 변경된 주요 내용 (PR base 이후)

| 영역 | 변경 내용 | PR 변경과 충돌 여부 |
|------|-----------|---------------------|
| `print_help()` | `--ismcptool`, `--addmcptool` 삭제 → `--currenttime`, `--cron` 시리즈 추가 | **간접 충돌** — help 텍스트 줄이 달라짐 |
| `handle_sendfile()` | 에러 메시지를 `serde_json::json!` 형식으로 변경 | 충돌 없음 |
| `handle_ismcptool()`, `handle_addmcptool()` | 두 함수 완전 삭제 | 충돌 없음 |
| `cron_debug()`, `handle_cron_register()` 등 | 스케줄링 시스템 대규모 추가 (~200줄) | 충돌 없음 |
| `CronContextArgs`, `handle_cron_context()` | cron context 백그라운드 처리 추가 | 충돌 없음 |
| `--ccserver` 핸들러 | **구조 동일** (565~577행) — 변경 없음 | **직접 적용 가능** |
| mod 선언부 | 변경 없음 | **직접 적용 가능** |

### 핵심 포인트

- `--ccserver` 핸들러 코드: PR base와 현재 main이 **완전히 동일** → PR의 변경을 그대로 적용 가능
- `print_help()`: PR base에는 `--ismcptool`/`--addmcptool`이 있었지만 현재 main에는 없음 → help 텍스트는 현재 main 기준으로 수동 적용 필요
- mod 선언부: 변경 없음 → 그대로 추가 가능

---

## 적용 방법

### 방법: 수동 Cherry-pick (권장)

PR의 변경이 4개 독립적 포인트에 집중되어 있고, 현재 main과의 충돌이 극히 제한적이므로 수동 적용이 가장 안전하고 깔끔합니다.

#### Step 1: `src/setup.rs` 신규 파일 생성

`prdiff3/after/src/setup.rs`를 `src/setup.rs`로 복사. 내용 변경 없이 그대로 사용.

#### Step 2: `src/main.rs` — mod 선언 추가 (6행 뒤)

현재 main.rs 6행:
```rust
mod enc;
```
→ 그 다음 줄에 추가:
```rust
mod setup;
```

#### Step 3: `src/main.rs` — `print_help()` 수정 (현재 43행)

현재:
```rust
println!("    --ccserver <TOKEN>...   Start Telegram bot server(s)");
```
→ 변경:
```rust
println!("    --setup                 Run interactive Telegram bot setup wizard");
println!("    --ccserver [TOKEN]...   Start Telegram bot server(s) (token optional if --setup was run)");
```

#### Step 4: `src/main.rs` — `--setup` 핸들러 삽입 (현재 564행과 565행 사이)

현재 `--base64` 핸들러(558~563행) 바로 뒤, `--ccserver`(565행) 바로 앞에 삽입:

```rust
            "--setup" => {
                if let Err(e) = setup::run_setup() {
                    eprintln!("Setup failed: {}", e);
                    std::process::exit(1);
                }
                return Ok(());
            }
```

#### Step 5: `src/main.rs` — `--ccserver` 핸들러 수정 (현재 565~577행)

현재 코드:
```rust
"--ccserver" => {
    let tokens: Vec<String> = args[i + 1..].iter()
        .filter(|a| !a.starts_with('-'))
        .cloned()
        .collect();
    if tokens.is_empty() {
        eprintln!("Error: --ccserver requires at least one token argument");
        eprintln!("Usage: cokacdir --ccserver <TOKEN> [TOKEN2] ...");
        return Ok(());
    }
    handle_ccserver(tokens);
    return Ok(());
}
```

→ 변경:
```rust
"--ccserver" => {
    let mut tokens: Vec<String> = if i + 1 < args.len() {
        args[i + 1..].iter()
            .filter(|a| !a.starts_with('-'))
            .cloned()
            .collect()
    } else {
        Vec::new()
    };
    // If no tokens provided via CLI, try loading from config
    if tokens.is_empty() {
        if let Some(saved_token) = setup::load_saved_token() {
            tokens.push(saved_token);
        } else {
            eprintln!("Error: --ccserver requires at least one token argument");
            eprintln!("Usage: cokacdir --ccserver <TOKEN> [TOKEN2] ...");
            eprintln!("       or run 'cokacdir --setup' to configure a token");
            return Ok(());
        }
    }
    handle_ccserver(tokens);
    return Ok(());
}
```

---

## 의존성 확인

| 의존성 | 상태 | 비고 |
|--------|------|------|
| `serde_json` | Cargo.toml에 이미 있음 (18행) | `setup.rs`의 JSON 직렬화에 사용 |
| `dirs` | Cargo.toml에 이미 있음 (20행) | `setup.rs`의 `dirs::home_dir()`에 사용 |
| `std::process::Command` | 표준 라이브러리 | `setup.rs`의 git/gh 버전 확인에 사용 |

추가 의존성 필요 없음.

---

## Config 파일 경로 충돌 분석

| 파일 | 경로 | 용도 |
|------|------|------|
| 기존 `config.rs` | `~/.cokacdir/settings.json` | 앱 설정 (테마, 키바인딩 등) |
| 신규 `setup.rs` | `~/.cokacdir/config.json` | Telegram 봇 토큰, 언어, 작업 디렉토리 |

두 파일은 같은 디렉토리(`~/.cokacdir/`)를 공유하지만 파일명이 다르므로 충돌 없음.

다만 **네이밍 일관성** 관점에서 `config.json` vs `settings.json`이 혼란스러울 수 있음. 이는 코드 리뷰 코멘트로 제안할 수 있는 사항 (예: `bot_config.json` 또는 `telegram.json`으로 변경 제안).

---

## 코드 품질 평가

### 장점

1. **깔끔한 모듈 분리**: 기존 코드를 건드리지 않고 독립 모듈(`setup.rs`)로 분리
2. **i18n 지원**: 한국어/영어 문자열을 const struct로 관리 — 확장 용이
3. **보안 의식**: 토큰 파일에 `0o600`, 디렉토리에 `0o700` 퍼미션 설정
4. **토큰 검증**: 형식 검증 로직이 합리적 (숫자ID:영숫자토큰)
5. **graceful fallback**: `--ccserver`에서 토큰 없으면 저장된 토큰 시도 → 그래도 없으면 안내 메시지
6. **의존성 최소화**: 새로운 crate 추가 없음

### 주의/개선 가능 사항

1. **`find_in_path()` 구현**: `which` crate 대신 직접 PATH 순회 — 동작하지만, Windows에서는 `.exe` 확장자 미처리. 현재 Unix-only라면 문제없음.
2. **`config_path()` 중복**: `setup.rs`에 자체 `config_path()` 함수가 있고, `config.rs`에도 `Settings::config_path()`가 있음. 다른 파일을 가리키므로 기능적 충돌은 없지만, 함수명이 동일해 혼란 가능.
3. **3회 시도 후 종료**: 토큰 검증 실패 시 `Err` 반환 → `run_setup()`이 실패하면 `main()`에서 `process::exit(1)`. 사용자 경험상 재시도 없이 바로 종료됨 — 의도적 설계로 보임.
4. **`working_directory` 설정의 활용처 미정**: `config.json`에 `working_directory`를 저장하지만, 현재 `load_saved_token()`만 public이고 working_directory를 읽는 API는 없음. 향후 확장을 위한 선행 작업으로 추정.

---

## 최종 판단

### 적용 난이도: **낮음**

- 신규 파일 1개 복사 + main.rs 4개소 수동 편집
- 기존 기능과의 충돌 없음
- 의존성 추가 없음

### 적용 권장 여부: **적용 가능**

PR의 변경은 기능적으로 독립적이고, 코드 품질이 양호하며, 기존 동작을 변경하지 않음 (additive change). `--ccserver` 사용 시 매번 토큰을 입력해야 하는 불편함을 해소하는 실용적 기능.

### 적용 시 주의점

- `config.json` 파일명에 대한 네이밍 규칙 합의 필요 (선택사항)
- `setup.rs`의 `config_path()` 함수가 `config.rs`의 `Settings::config_path()`와 이름이 같으므로, 향후 리팩터링 시 혼동 가능성 인지
