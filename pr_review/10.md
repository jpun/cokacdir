# PR #10 ë¶„ì„: telegram.rs ëª¨ë“ˆ ë¶„ë¦¬ ë¦¬íŒ©í† ë§

## 1. ê°œìš”

### PR ë‚´ìš©
`src/services/telegram.rs` ë‹¨ì¼ íŒŒì¼(2,753ì¤„)ì„ 7ê°œ ì„œë¸Œëª¨ë“ˆ ë””ë ‰í† ë¦¬ë¡œ ë¶„ë¦¬í•˜ëŠ” ë¦¬íŒ©í† ë§.

### íŒŒì¼ êµ¬ì¡° ë³€ê²½

```
[Before]
src/services/telegram.rs  (2,753ì¤„)

[After]
src/services/telegram/
â”œâ”€â”€ mod.rs       (169ì¤„) â€” êµ¬ì¡°ì²´ ì •ì˜, run_bot(), ê³µí†µ ë§¤í¬ë¡œ
â”œâ”€â”€ commands.rs  (455ì¤„) â€” /help, /start, /clear, /pwd, /stop, /public, /debug, /setpollingtime
â”œâ”€â”€ file_ops.rs  (557ì¤„) â€” /down, íŒŒì¼ ì—…ë¡œë“œ, ì…¸ ëª…ë ¹ ì‹¤í–‰, ì—…ë¡œë“œ í ì²˜ë¦¬
â”œâ”€â”€ message.rs   (735ì¤„) â€” handle_message() ë¼ìš°í„°, handle_text_message() AI ì±„íŒ…
â”œâ”€â”€ storage.rs   (263ì¤„) â€” ì„¸ì…˜/ì„¤ì • ì €ì¥Â·ë¡œë“œ, token_hash
â”œâ”€â”€ streaming.rs (336ì¤„) â€” ë©”ì‹œì§€ ì „ì†¡, HTML ë³€í™˜, ë§ˆí¬ë‹¤ìš´ ì²˜ë¦¬, rate limit
â””â”€â”€ tools.rs     (375ì¤„) â€” ë„êµ¬ ê´€ë¦¬, /availabletools, /allowedtools, /allowed, format_tool_input
                 â”€â”€â”€â”€â”€
                 2,890ì¤„ (ì´í•©, +137ì¤„ ì¦ê°€)
```

### í˜„ì¬ Main ìƒíƒœ
í˜„ì¬ mainì˜ `src/services/telegram.rs`ëŠ” **4,222ì¤„**ë¡œ PR ë² ì´ìŠ¤ ëŒ€ë¹„ **+1,469ì¤„** ì¦ê°€.

---

## 2. PRì˜ ì‹¤ì§ˆì  ë³€ê²½ ì‚¬í•­ (íŒŒì¼ ë¶„ë¦¬ ì™¸)

### 2-1. ì‹ ê·œ ê¸°ëŠ¥: `cleanup_stale_sessions()` (storage.rs:220-248)

PR beforeì— ì—†ëŠ” **ì™„ì „íˆ ìƒˆë¡œìš´ í•¨ìˆ˜**. ì§€ì •ëœ ì¼ìˆ˜(30ì¼)ë³´ë‹¤ ì˜¤ë˜ëœ ì„¸ì…˜ JSON íŒŒì¼ì„ ìë™ ì‚­ì œí•œë‹¤.

```rust
// mod.rs:119 ì—ì„œ í˜¸ì¶œ
cleanup_stale_sessions(30);
```

ì‚­ì œëœ íŒŒì¼ ìˆ˜ë¥¼ ì½˜ì†”ì— ì¶œë ¥:
```rust
println!("  âœ“ Cleaned up {deleted} stale session file(s) older than {max_age_days} days");
```

### 2-2. ì‹ ê·œ ê¸°ëŠ¥: `delete_session_file()` (storage.rs:252-261)

session_idë¡œ íŠ¹ì • ì„¸ì…˜ íŒŒì¼ì„ ë””ìŠ¤í¬ì—ì„œ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜. `/clear` ëª…ë ¹ì–´ í•¸ë“¤ëŸ¬ì—ì„œ í˜¸ì¶œëœë‹¤.

```rust
// commands.rs:233-236
if let Some(ref sid) = session_id_to_delete {
    delete_session_file(sid);
}
```

**ê¸°ì¡´ before ì½”ë“œ**ì—ì„œ `/clear`ëŠ” ì¸ë©”ëª¨ë¦¬ ìƒíƒœë§Œ ì´ˆê¸°í™”í–ˆìœ¼ë‚˜, PR ì´í›„ì—ëŠ” ë””ìŠ¤í¬ì˜ ì„¸ì…˜ íŒŒì¼ë„ ì‚­ì œí•œë‹¤.

### 2-3. ê°€ì‹œì„±(Visibility) ë³€ê²½

ëª¨ë“ˆ ë¶„ë¦¬ë¥¼ ìœ„í•´ `pub(crate)`ë¡œ ë³€ê²½ëœ í•­ëª©ë“¤:

| í•­ëª© | before | after |
|------|--------|-------|
| `TG_DEBUG` static | ë¹„ê³µê°œ | `pub(crate)` |
| `tg_debug()` í•¨ìˆ˜ | ë¹„ê³µê°œ | `pub(crate)` |
| `tg!` ë§¤í¬ë¡œ | ë¡œì»¬ | `pub(crate) use tg;` + `$crate::` ê²½ë¡œ |
| `ChatSession` êµ¬ì¡°ì²´ + ëª¨ë“  í•„ë“œ | ë¹„ê³µê°œ | `pub(crate)` |
| `BotSettings` êµ¬ì¡°ì²´ + ëª¨ë“  í•„ë“œ | ë¹„ê³µê°œ | `pub(crate)` |
| `SharedData` êµ¬ì¡°ì²´ + ëª¨ë“  í•„ë“œ | ë¹„ê³µê°œ | `pub(crate)` |
| `SharedState` íƒ€ì… | ë¹„ê³µê°œ | `pub(crate)` |
| `TELEGRAM_MSG_LIMIT` ìƒìˆ˜ | ë¹„ê³µê°œ | `pub(crate)` |

### 2-4. `tg!` ë§¤í¬ë¡œ ê²½ë¡œ ë³€ê²½

```rust
// before (ë¡œì»¬ ê²½ë¡œ)
tg_debug($name, &r);

// after ($crate ì ˆëŒ€ ê²½ë¡œ)
$crate::services::telegram::tg_debug($name, &r);
```

ì„œë¸Œëª¨ë“ˆì—ì„œë„ ë§¤í¬ë¡œê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ë³€ê²½.

### 2-5. `imprinted` ë³€ìˆ˜ ì²˜ë¦¬

```rust
// before: if ë¸”ë¡ìœ¼ë¡œ ì²˜ë¦¬
if imprinted {
    // Owner registration is logged to server console only
    // No response sent to the user
}

// after: let _ íŒ¨í„´
let _ = imprinted; // Owner registration is logged to server console only
```

### 2-6. `preview` ë³€ìˆ˜ (message.rs:155)

```rust
let preview = truncate_str(&text, 60);
```

beforeì™€ ë™ì¼í•˜ê²Œ 60ìë¡œ ì˜ë¼ì„œ ì‚¬ìš© (í˜„ì¬ mainì€ `let preview = &text;`ë¡œ ë³€ê²½ë¨).

---

## 3. í˜„ì¬ Mainì—ë§Œ ì¡´ì¬í•˜ëŠ” ê¸°ëŠ¥ (PRì— ì—†ìŒ)

### 3-1. ìŠ¤ì¼€ì¤„ë§ ì‹œìŠ¤í…œ (~630ì¤„, main:109-373 + 3595-4222)

ê°€ì¥ í° ì¶”ê°€ ê¸°ëŠ¥. cron í‘œí˜„ì‹ ë° ì¼íšŒì„± ì˜ˆì•½ ì‹¤í–‰ ì‹œìŠ¤í…œ.

**êµ¬ì¡°ì²´ ë° í•µì‹¬ í•¨ìˆ˜:**

| í•¨ìˆ˜/êµ¬ì¡°ì²´ | Main ë¼ì¸ | ì„¤ëª… |
|------------|-----------|------|
| `ScheduleEntry` struct | 110-123 | ìŠ¤ì¼€ì¤„ ë°ì´í„° ëª¨ë¸ (id, chat_id, prompt, schedule, cron ë“±) |
| `schedule_dir()` | 126-128 | `~/.cokacdir/schedule/` ê²½ë¡œ |
| `read_schedule_entry()` | 133-149 | JSON â†’ ScheduleEntry íŒŒì‹± |
| `write_schedule_entry()` | 152-174 | ScheduleEntry â†’ JSON ì €ì¥ (ì›ìì  ì“°ê¸°) |
| `list_schedule_entries()` | 177-189 | bot_key/chat_id ê¸°ì¤€ ì¡°íšŒ |
| `delete_schedule_entry()` | 192-196 | IDë¡œ ì‚­ì œ |
| `parse_relative_time()` | 199-212 | "4h", "30m", "1d" íŒŒì‹± |
| `cron_matches()` | 216-240 | 5-field cron í‘œí˜„ì‹ ë§¤ì¹­ |
| `cron_field_matches()` | 245-275 | cron í•„ë“œ ê°œë³„ ë§¤ì¹­ (*, ë²”ìœ„, ìŠ¤í…) |
| `ScheduleEntryData` (pub) | 281-311 | ì™¸ë¶€ ëª¨ë“ˆìš© ê³µê°œ ë°ì´í„° struct |
| `From` impls | 295-329 | ScheduleEntry â†” ScheduleEntryData ë³€í™˜ |
| `parse_relative_time_pub()` | 331-333 | pub wrapper |
| `write_schedule_entry_pub()` | 335-338 | pub wrapper |
| `list_schedule_entries_pub()` | 340-342 | pub wrapper |
| `list_all_schedule_ids_pub()` | 344-358 | ëª¨ë“  ìŠ¤ì¼€ì¤„ ID ì¡°íšŒ |
| `delete_schedule_entry_pub()` | 360-362 | pub wrapper |
| `resolve_current_path_for_chat()` | 365-373 | chat_id â†’ ê²½ë¡œ í•´ì„ |
| `should_trigger()` | 3595-3633 | ìŠ¤ì¼€ì¤„ íŠ¸ë¦¬ê±° íŒì • |
| `update_schedule_after_run()` | 3634-3667 | ì‹¤í–‰ í›„ ìŠ¤ì¼€ì¤„ ìƒíƒœ ê°±ì‹  |
| `execute_schedule()` | 3668-4118 | ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì—”ì§„ (~450ì¤„) |
| `scheduler_loop()` | 4119-4222 | 5ì´ˆ ê°„ê²© ë©”ì¸ ìŠ¤ì¼€ì¤„ëŸ¬ ë£¨í”„ |

### 3-2. ëª¨ë¸ ì„ íƒ ì‹œìŠ¤í…œ (~90ì¤„)

| í•¨ìˆ˜ | Main ë¼ì¸ | ì„¤ëª… |
|------|-----------|------|
| `get_model()` | 104-107 | chat_idë³„ ëª¨ë¸ ì¡°íšŒ |
| `resolve_model_name()` | 2243-2249 | ëª¨ë¸ ë³„ì¹­ â†’ ì‹¤ì œ ì´ë¦„ í•´ì„ |
| `display_model_name()` | 2252-2254 | í‘œì‹œìš© ëª¨ë¸ ì´ë¦„ |
| `handle_model_command()` | 2257-2328 | `/model` ëª…ë ¹ì–´ í•¸ë“¤ëŸ¬ |

`BotSettings`ì— `models: HashMap<String, String>` í•„ë“œ ì¶”ê°€ (main:75-76).

### 3-3. ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID ì´ë ¥ ë³µì› (~120ì¤„)

| í•¨ìˆ˜ | Main ë¼ì¸ | ì„¤ëª… |
|------|-----------|------|
| `build_history_preview()` | 1200-1235 | ë°”ì´íŠ¸ ì˜ˆì‚° ë‚´ì—ì„œ ì„¸ì…˜ ì´ë ¥ ë¯¸ë¦¬ë³´ê¸° ìƒì„± |
| `is_workspace_id()` | 1238-1240 | 8ì ì˜ìˆ«ì ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID ê²€ì¦ |
| `handle_workspace_resume()` | 1243-1323 | `/<workspace_id>` ëª…ë ¹ìœ¼ë¡œ ë¹ ë¥¸ ì„¸ì…˜ ë³µì› |

### 3-4. `build_system_prompt()` (main:376-442)

ê¸°ì¡´ ì¸ë¼ì¸ `format!()` ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ë³„ë„ í•¨ìˆ˜ë¡œ ì¶”ì¶œ. cokacdir ëª…ë ¹ì–´ ë ˆí¼ëŸ°ìŠ¤(sendfile, cron, cron-list, cron-remove, cron-update)ë¥¼ í¬í•¨í•˜ëŠ” í†µí•© ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¹Œë”.

### 3-5. cokacdir ëª…ë ¹ í¬ë§·íŒ… (~110ì¤„)

| í•¨ìˆ˜ | Main ë¼ì¸ | ì„¤ëª… |
|------|-----------|------|
| `detect_cokacdir_command()` | 3318-3332 | Bash ë„êµ¬ ì…ë ¥ì—ì„œ cokacdir ëª…ë ¹ íƒì§€ |
| `read_latest_cron_result()` | 3334-3347 | cron ì‹¤í–‰ ê²°ê³¼ ì„ì‹œíŒŒì¼ ì½ê¸° |
| `format_cokacdir_result()` | 3348-3418 | cokacdir ëª…ë ¹ ê²°ê³¼ í¬ë§·íŒ… (sendfile, cron ë“±) |
| `format_bash_command()` | 3419-3431 | Bash ë„êµ¬ JSONì—ì„œ ëª…ë ¹ì–´ ì¶”ì¶œ |

### 3-6. ë²„ì „ ì²´í¬ ì‹œìŠ¤í…œ (main:446-471)

| í•¨ìˆ˜ | Main ë¼ì¸ | ì„¤ëª… |
|------|-----------|------|
| `check_latest_version()` | 446-461 | GitHubì—ì„œ ìµœì‹  Cargo.toml ê°€ì ¸ì™€ ë²„ì „ ë¹„êµ |
| `version_is_newer()` | 464-471 | semver ë¹„êµ |

### 3-7. ì‹œì‘ ì¸ì‚¬ ë©”ì‹œì§€ (main:731-750)

ë´‡ ì‹œì‘ ì‹œ ì•Œë ¤ì§„ ëª¨ë“  chat_idì— ë²„ì „ ì •ë³´ì™€ ì—…ë°ì´íŠ¸ ì•Œë¦¼ì„ ì „ì†¡:
```
ğŸŸ¢ cokacdir started (v{version})
ğŸ“‚ Resuming session at {last_path}
ğŸ†• v{latest} available â€” https://cokacdir.cokac.com/
```

### 3-8. ë””ë²„ê·¸ ì„¤ì • ì˜ì†í™” (main:77-78, 683-687)

- `BotSettings`ì— `debug: bool` í•„ë“œ ì¶”ê°€
- ë´‡ ì‹œì‘ ì‹œ ì €ì¥ëœ debug ìƒíƒœ ë³µì›
- `handle_debug_command`ê°€ `token` ë§¤ê°œë³€ìˆ˜ë¥¼ ë°›ì•„ ì„¤ì • íŒŒì¼ì— ì €ì¥
- `claude::DEBUG_ENABLED`ë„ í•¨ê»˜ í† ê¸€

### 3-9. UI í…ìŠ¤íŠ¸ ë³€ê²½ (í•œêµ­ì–´ â†’ ì˜ì–´)

ì…¸ ëª…ë ¹ ì‹¤í–‰ ì‹œ í‘œì‹œë˜ëŠ” í…ìŠ¤íŠ¸ê°€ ë³€ê²½:

```
// before (PRì—ì„œë„ ë™ì¼)
"!{}ì— ëŒ€í•´ì„œ ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤."
"!{} ì™„ë£Œ (exit code: {})"

// í˜„ì¬ main
"Processing <code>{}</code>"
"Done <code>{}</code> (exit code: {})"
```

### 3-10. ê¸°íƒ€ ë³€ê²½ì‚¬í•­

| í•­ëª© | PR/before | í˜„ì¬ Main | Main ë¼ì¸ |
|------|-----------|-----------|-----------|
| `ChatSession` derive | ì—†ìŒ | `#[derive(Clone)]` | 53 |
| `SharedData.pending_schedules` | ì—†ìŒ | `HashMap<ChatId, HashSet<String>>` | 486 |
| `preview` ë³€ìˆ˜ | `truncate_str(&text, 60)` | `&text` (ì „ì²´ í…ìŠ¤íŠ¸) | 903 |
| `save_bot_settings()` ì“°ê¸° | ì§ì ‘ `fs::write` | ì›ìì  (tmp â†’ rename) | 614-617 |
| `save_session_to_file()` ë³´ì•ˆ | parent ë””ë ‰í† ë¦¬ ê²€ì¦ | ì˜ìˆ«ì+í•˜ì´í”ˆ+ì–¸ë”ìŠ¤ì½”ì–´ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ | 2896-2899 |
| `/start` ì‘ë‹µ ë Œë”ë§ | í”Œë ˆì¸ í…ìŠ¤íŠ¸ | HTML (`markdown_to_telegram_html`) | 1168-1196 |
| `/pwd` ì‘ë‹µ | ê²½ë¡œë§Œ í‘œì‹œ | ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID íŒíŠ¸ í¬í•¨ | 1393-1418 |
| `/help` í…ìŠ¤íŠ¸ | ê¸°ë³¸ ëª…ë ¹ì–´ë§Œ | Schedule, /model ì„¹ì…˜ ì¶”ê°€ | 1012-1072 |
| `run_bot()` commands | `/debug` ê¹Œì§€ | `/model` ëª…ë ¹ì–´ ì¶”ê°€ | 702 |
| `execute_command_streaming()` í˜¸ì¶œ | ì¸ì 7ê°œ | ì¸ì 9ê°œ (model, false ì¶”ê°€) | 2437 |

---

## 4. ëª¨ë“ˆë³„ ìƒì„¸ ë§¤í•‘: PR after â†’ í˜„ì¬ Main

### 4-1. mod.rs (169ì¤„) â†’ Main ëŒ€ì‘

| PR mod.rs | ë‚´ìš© | Main ë¼ì¸ | ìƒíƒœ |
|-----------|------|-----------|------|
| 1-9 | imports | 1-14 | Mainì´ ë” ë§ì€ import |
| 23 | `TG_DEBUG` | 17 | ë™ì¼ |
| 26-47 | `tg_debug()` | 20-41 | ë™ì¼ |
| 50-57 | `tg!` macro | 44-50 | Mainì€ ë¡œì»¬ ê²½ë¡œ, PRì€ `$crate::` |
| 60-69 | `ChatSession` | 52-63 | **Mainì— `#[derive(Clone)]` ì¶”ê°€** |
| 73-91 | `BotSettings` | 66-92 | **Mainì— `models`, `debug` í•„ë“œ ì¶”ê°€** |
| 83-91 | `Default` impl | 82-91 | **Mainì— `models`, `debug` ì´ˆê¸°í™” ì¶”ê°€** |
| 95-106 | `SharedData` | 474-487 | **Mainì— `pending_schedules` í•„ë“œ ì¶”ê°€** |
| 108 | `SharedState` | 489 | ë™ì¼ |
| 111 | `TELEGRAM_MSG_LIMIT` | 492 | ë™ì¼ |
| 114-169 | `run_bot()` | 679-772 | **ëŒ€ê·œëª¨ ì°¨ì´** (ì•„ë˜ ìƒì„¸) |

**`run_bot()` ìƒì„¸ ì°¨ì´:**

PRì—ë§Œ ìˆëŠ” ê²ƒ:
- `cleanup_stale_sessions(30)` í˜¸ì¶œ (119í–‰)

Mainì—ë§Œ ìˆëŠ” ê²ƒ:
- debug í”Œë˜ê·¸ ë³µì› (683-687)
- `/model` bot command ë“±ë¡ (702)
- `pending_schedules` ì´ˆê¸°í™” (724)
- scheduler_loop ì‹œì‘ ë©”ì‹œì§€ (728)
- startup greeting ì „ì†¡ (731-750)
- scheduler_loop spawn (755-758)
- scheduler_handle.abort() (771)

### 4-2. commands.rs (455ì¤„) â†’ Main ëŒ€ì‘

| PR commands.rs í•¨ìˆ˜ | PR ë¼ì¸ | Main ë¼ì¸ | ì°¨ì´ |
|---------------------|---------|-----------|------|
| `handle_help_command` | 11-66 | 1012-1072 | **Main: Schedule, /model ì„¹ì…˜ ì¶”ê°€** |
| `handle_start_command` | 69-195 | 1075-1196 | **Main: `build_history_preview()` ì‚¬ìš©, ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID íŒíŠ¸, HTML ë Œë”ë§** |
| `handle_clear_command` | 198-243 | 1326-1390 | **ê·¼ë³¸ì  ì°¨ì´: PRì€ session_id ê¸°ë°˜ ì‚­ì œ, Mainì€ ê²½ë¡œ ìŠ¤ìº” ê¸°ë°˜ ì‚­ì œ** |
| `handle_pwd_command` | 246-263 | 1393-1418 | **Main: ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ID íŒíŠ¸ ì¶”ê°€** |
| `handle_stop_command` | 266-318 | 1421-1473 | ë™ì¼í•œ ë¡œì§ |
| `handle_public_command` | 321-382 | 2178-2239 | ë™ì¼í•œ ë¡œì§ |
| `handle_debug_command` | 385-398 | 2056-2076 | **Main: `token` ë§¤ê°œë³€ìˆ˜ ì¶”ê°€, ì„¤ì • ì˜ì†í™”, `claude::DEBUG_ENABLED` í† ê¸€** |
| `handle_setpollingtime_command` | 401-454 | 2000-2053 | ë™ì¼í•œ ë¡œì§ |

Mainì—ë§Œ ìˆëŠ” í•¨ìˆ˜:
- `handle_model_command()` (2257-2328)
- `build_history_preview()` (1200-1235)
- `is_workspace_id()` (1238-1240)
- `handle_workspace_resume()` (1243-1323)
- `resolve_model_name()` (2243-2249)
- `display_model_name()` (2252-2254)

### 4-3. file_ops.rs (557ì¤„) â†’ Main ëŒ€ì‘

| PR file_ops.rs í•¨ìˆ˜ | PR ë¼ì¸ | Main ë¼ì¸ | ì°¨ì´ |
|---------------------|---------|-----------|------|
| `ShellOutput` enum | 18-22 | 1624-1629 | ë™ì¼ |
| `handle_down_command` | 25-76 | 1476-1527 | ë™ì¼ |
| `handle_file_upload` | 79-171 | 1530-1622 | ë™ì¼ |
| `handle_shell_command` | 174-481 | 1632-1943 | **UI í…ìŠ¤íŠ¸ ì°¨ì´: í•œêµ­ì–´ vs ì˜ì–´, HTML í¬ë§·** |
| `process_upload_queue` | 487-557 | 2925-2995 | ë™ì¼ |

**handle_shell_command UI í…ìŠ¤íŠ¸ ìƒì„¸ ì°¨ì´:**

| ìœ„ì¹˜ | PR (file_ops.rs) | Main |
|------|------------------|------|
| ì²˜ë¦¬ì¤‘ placeholder | `"!{}ì— ëŒ€í•´ì„œ ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤."` | `format!("Processing <code>{}</code>", ...)` + HTML ParseMode |
| ìŠ¤í”¼ë„ˆ í…ìŠ¤íŠ¸ | `"!{}ì— ëŒ€í•´ì„œ ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤.\n\n{}"` | `format!("Processing <code>{}</code>\n\n{}", ...)` + HTML |
| ì™„ë£Œ (ì§§ì€ ì¶œë ¥) | `"!{} ì™„ë£Œ (exit code: {})\n\n<pre>..."` | `format!("Done <code>{}</code> (exit code: {})\n\n<pre>..."` |
| ì™„ë£Œ (ê¸´ ì¶œë ¥) | `"!{} ì™„ë£Œ (exit code: {})"` | `format!("Done <code>{}</code> (exit code: {})")` |
| ì™„ë£Œ (ì¶œë ¥ ì—†ìŒ) | `"!{} ì™„ë£Œ (exit code: {})"` | `format!("Done <code>{}</code> (exit code: {})")` |

### 4-4. message.rs (735ì¤„) â†’ Main ëŒ€ì‘

| PR message.rs í•¨ìˆ˜ | PR ë¼ì¸ | Main ë¼ì¸ | ì°¨ì´ |
|--------------------|---------|-----------|------|
| `handle_message` | 30-254 | 775-1009 | **ë‹¤ìˆ˜ ì°¨ì´** (ì•„ë˜ ìƒì„¸) |
| `handle_text_message` | 257-735 | 2331-2821 | **ëŒ€ê·œëª¨ ì°¨ì´** (ì•„ë˜ ìƒì„¸) |

**handle_message ì°¨ì´:**

| í•­ëª© | PR | Main |
|------|-----|------|
| `imprinted` ì²˜ë¦¬ | `let _ = imprinted;` | `if imprinted { ... }` |
| `preview` ë³€ìˆ˜ | `truncate_str(&text, 60)` | `&text` |
| `/model` ë¼ìš°íŒ… | ì—†ìŒ | ìˆìŒ (979-981) |
| workspace ID ë¼ìš°íŒ… | ì—†ìŒ | ìˆìŒ (988-991) |
| `handle_debug_command` í˜¸ì¶œ | `(&bot, chat_id, &state)` | `(&bot, chat_id, &state, token)` |

**handle_text_message ì°¨ì´:**

| í•­ëª© | PR (message.rs) | Main |
|------|-----------------|------|
| ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ | ì¸ë¼ì¸ `format!()` (331-346) | `build_system_prompt()` í˜¸ì¶œ |
| ëª¨ë¸ ë§¤ê°œë³€ìˆ˜ | ì—†ìŒ | `get_model()` â†’ `resolve_model_name()` |
| `execute_command_streaming` í˜¸ì¶œ | 7ê°œ ì¸ì | 9ê°œ ì¸ì (`model.as_deref()`, `false` ì¶”ê°€) |
| ToolUse ì²˜ë¦¬ | `format_tool_input` ë§Œ í˜¸ì¶œ | `detect_cokacdir_command`, `format_bash_command` ì¶”ê°€ |
| ToolResult ì²˜ë¦¬ | ë‹¨ìˆœ truncate + ì½”ë“œë¸”ë¡ | cokacdir ëª…ë ¹ ê²°ê³¼ íŠ¹í™” í¬ë§·íŒ… |
| `pending_cokacdir_cmd` ë³€ìˆ˜ | ì—†ìŒ | ìˆìŒ |
| `last_tool_name` ë³€ìˆ˜ | ì—†ìŒ | ìˆìŒ |

### 4-5. storage.rs (263ì¤„) â†’ Main ëŒ€ì‘

| PR storage.rs í•¨ìˆ˜ | PR ë¼ì¸ | Main ë¼ì¸ | ì°¨ì´ |
|--------------------|---------|-----------|------|
| `token_hash` | 11-16 | 495-500 | ë™ì¼ |
| `bot_settings_path` | 19-21 | 503-505 | ë™ì¼ |
| `load_bot_settings` | 24-89 | 508-585 | **Main: `models` HashMap, `debug` bool ë¡œë”© ì¶”ê°€** |
| `save_bot_settings` | 93-119 | 588-619 | **Main: `models`, `debug` JSON í¬í•¨ + ì›ìì  ì“°ê¸°** |
| `resolve_token_by_hash` | 122-129 | 622-629 | ë™ì¼ |
| `load_existing_session` | 132-167 | 2824-2859 | ë™ì¼ |
| `save_session_to_file` | 170-216 | 2862-2906 | **ë³´ì•ˆ ê²€ì¦ ë°©ì‹ ì°¨ì´** |
| `cleanup_stale_sessions` | 220-248 | ì—†ìŒ | **PR ì‹ ê·œ** |
| `delete_session_file` | 252-261 | ì—†ìŒ | **PR ì‹ ê·œ** |

**save_bot_settings ì›ìì  ì“°ê¸° ì°¨ì´:**

```rust
// PR (storage.rs:116-118) â€” ì§ì ‘ ì“°ê¸°
if let Ok(s) = serde_json::to_string_pretty(&json) {
    let _ = fs::write(&path, s);
}

// Main (main:613-618) â€” ì›ìì  ì“°ê¸° (crash-safe)
if let Ok(s) = serde_json::to_string_pretty(&json) {
    let tmp_path = path.with_extension("json.tmp");
    if fs::write(&tmp_path, &s).is_ok() {
        let _ = fs::rename(&tmp_path, &path);
    }
}
```

**save_session_to_file ë³´ì•ˆ ê²€ì¦ ì°¨ì´:**

```rust
// PR (storage.rs:207-211) â€” parent ê²½ë¡œ ë¹„êµ
if let Some(parent) = file_path.parent() {
    if parent != sessions_dir {
        return;
    }
}

// Main (main:2896-2899) â€” í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë¬¸ì ê²€ì¦
if !session_id.chars().all(|c| c.is_alphanumeric() || c == '-' || c == '_') {
    return;
}
```

### 4-6. streaming.rs (336ì¤„) â†’ Main ëŒ€ì‘

| PR streaming.rs í•¨ìˆ˜ | PR ë¼ì¸ | Main ë¼ì¸ | ì°¨ì´ |
|----------------------|---------|-----------|------|
| `floor_char_boundary` | 7-17 | 2909-2919 | **ë™ì¼** |
| `shared_rate_limit_wait` | 22-36 | 3000-3014 | **ë™ì¼** |
| `send_long_message` | 41-124 | 3019-3103 | **ë™ì¼** |
| `normalize_empty_lines` | 127-148 | 3105-3127 | **ë™ì¼** |
| `html_escape` | 151-155 | 3129-3133 | **ë™ì¼** |
| `truncate_str` | 158-170 | 3136-3148 | **ë™ì¼** |
| `markdown_to_telegram_html` | 173-230 | 3151-3208 | **ë™ì¼** |
| `strip_heading` | 233-243 | 3211-3221 | **ë™ì¼** |
| `convert_inline` | 246-271 | 3224-3249 | **ë™ì¼** |
| `convert_bold_italic` | 274-304 | 3252-3282 | **ë™ì¼** |
| `find_closing_marker` | 307-320 | 3285-3298 | **ë™ì¼** |
| `find_closing_single` | 323-336 | 3301-3314 | **ë™ì¼** |

**12ê°œ í•¨ìˆ˜ ëª¨ë‘ 100% ë™ì¼. ì¶©ëŒ ì—†ìŒ.**

### 4-7. tools.rs (375ì¤„) â†’ Main ëŒ€ì‘

| PR tools.rs í•¨ìˆ˜ | PR ë¼ì¸ | Main ë¼ì¸ | ì°¨ì´ |
|------------------|---------|-----------|------|
| `get_allowed_tools` | 11-16 | 96-101 | **ë™ì¼** (Mainì—ì„œëŠ” mod.rs ë²”ìœ„ ë‚´) |
| `normalize_tool_name` | 19-26 | 632-639 | **ë™ì¼** |
| `ALL_TOOLS` | 29-50 | 642-663 | **ë™ì¼** |
| `tool_info` | 53-58 | 666-671 | **ë™ì¼** |
| `risk_badge` | 61-63 | 674-676 | **ë™ì¼** |
| `handle_availabletools_command` | 66-86 | 1946-1966 | **ë™ì¼** |
| `handle_allowedtools_command` | 89-117 | 1969-1997 | **ë™ì¼** |
| `handle_allowed_command` | 123-215 | 2083-2175 | **ë™ì¼** |
| `format_tool_input` | 218-375 | 3433-3594 | **ë™ì¼** |

Mainì—ë§Œ ìˆëŠ” í•¨ìˆ˜:
- `detect_cokacdir_command()` (3318-3332)
- `read_latest_cron_result()` (3334-3347)
- `format_cokacdir_result()` (3348-3418)
- `format_bash_command()` (3419-3431)

---

## 5. ì¶©ëŒ ë¶„ì„

### 5-1. ì»´íŒŒì¼ ë¶ˆê°€ ìˆ˜ì¤€ (Critical)

| # | ì¶©ëŒ í•­ëª© | PR ìƒíƒœ | Main ìƒíƒœ | ì˜í–¥ |
|---|----------|---------|-----------|------|
| C1 | `BotSettings` í•„ë“œ | 4ê°œ í•„ë“œ | 6ê°œ í•„ë“œ (`models`, `debug` ì¶”ê°€) | ëª¨ë“  BotSettings ìƒì„±/ì ‘ê·¼ ì½”ë“œ ì‹¤íŒ¨ |
| C2 | `SharedData` í•„ë“œ | 6ê°œ í•„ë“œ | 7ê°œ í•„ë“œ (`pending_schedules` ì¶”ê°€) | `run_bot()` ì´ˆê¸°í™” ì‹¤íŒ¨ |
| C3 | `ChatSession` derive | derive ì—†ìŒ | `#[derive(Clone)]` | ìŠ¤ì¼€ì¤„ ì‹œìŠ¤í…œì—ì„œ clone ë¶ˆê°€ |
| C4 | `execute_command_streaming()` í˜¸ì¶œ | 7ê°œ ì¸ì | 9ê°œ ì¸ì | ì»´íŒŒì¼ ì—ëŸ¬ |
| C5 | `handle_debug_command()` ì‹œê·¸ë‹ˆì²˜ | `(bot, chat_id, state)` | `(bot, chat_id, state, token)` | í˜¸ì¶œë¶€ ë¶ˆì¼ì¹˜ |
| C6 | `handle_message()` ë¼ìš°íŒ… | `/model`, workspace ì—†ìŒ | `/model`, workspace ìˆìŒ | ê¸°ëŠ¥ ëˆ„ë½ |
| C7 | `run_bot()` ì´ˆê¸°í™” | ê¸°ë³¸ êµ¬ì¡°ë§Œ | scheduler + greeting + debug ë³µì› | ê¸°ëŠ¥ ëˆ„ë½ |

### 5-2. ë™ì‘ ì°¨ì´ ìˆ˜ì¤€ (Moderate)

| # | í•­ëª© | PR | Main |
|---|------|-----|------|
| M1 | `/clear` ì„¸ì…˜ ì‚­ì œ | session_id ê¸°ë°˜ `delete_session_file()` | ê²½ë¡œ ìŠ¤ìº” ê¸°ë°˜ (ë””ë ‰í† ë¦¬ ì „ì²´ ê²€ìƒ‰) |
| M2 | `/start` ì‘ë‹µ | í”Œë ˆì¸ í…ìŠ¤íŠ¸ | HTML ë Œë”ë§ |
| M3 | `/help` ë‚´ìš© | ê¸°ë³¸ ëª…ë ¹ì–´ | Schedule, /model ì„¹ì…˜ í¬í•¨ |
| M4 | `/pwd` ì‘ë‹µ | ê²½ë¡œë§Œ | ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒíŠ¸ í¬í•¨ |
| M5 | ì…¸ ëª…ë ¹ UI | í•œêµ­ì–´ `"ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤"` | ì˜ì–´ `"Processing"` + HTML |
| M6 | `save_bot_settings()` | ì§ì ‘ ì“°ê¸° | ì›ìì  ì“°ê¸° (tmp â†’ rename) |
| M7 | `save_session_to_file()` ê²€ì¦ | parent ê²½ë¡œ ë¹„êµ | ë¬¸ì í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ |
| M8 | ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ | ì¸ë¼ì¸ í¬ë§· | `build_system_prompt()` (cokacdir ë ˆí¼ëŸ°ìŠ¤ í¬í•¨) |
| M9 | ToolUse/ToolResult í¬ë§· | ê¸°ë³¸ í¬ë§·ë§Œ | cokacdir ëª…ë ¹ íŠ¹í™” í¬ë§· |
| M10 | `preview` ë³€ìˆ˜ | `truncate_str(&text, 60)` | `&text` |

### 5-3. ì¶©ëŒ ì—†ìŒ (Clean)

- **streaming.rs**: 12ê°œ í•¨ìˆ˜ ëª¨ë‘ 100% ë™ì¼
- **tools.rs**: ê¸°ì¡´ 9ê°œ í•¨ìˆ˜ ëª¨ë‘ ë™ì¼ (Mainì˜ ì‹ ê·œ 4ê°œ í•¨ìˆ˜ë§Œ ì¶”ê°€ í•„ìš”)
- **file_ops.rs**: `handle_down_command`, `handle_file_upload`, `process_upload_queue` ë™ì¼ (`handle_shell_command` UI í…ìŠ¤íŠ¸ë§Œ ì°¨ì´)

---

## 6. Mainì—ë§Œ ìˆëŠ” ì½”ë“œ ì´ì •ë¦¬ (~1,450ì¤„)

PRì— ì¡´ì¬í•˜ì§€ ì•Šì•„ ì ìš© ì‹œ ë°˜ë“œì‹œ ì¶”ê°€í•´ì•¼ í•˜ëŠ” ì½”ë“œ:

| ê¸°ëŠ¥ | Main ë¼ì¸ | ì¤„ ìˆ˜ | ì í•©í•œ ì„œë¸Œëª¨ë“ˆ |
|------|-----------|-------|----------------|
| `get_model()` | 104-107 | 4 | mod.rs ë˜ëŠ” ìƒˆ schedule.rs |
| `ScheduleEntry` + ê´€ë ¨ í•¨ìˆ˜ ì „ì²´ | 109-373 | 265 | **ì‹ ê·œ schedule.rs** |
| `build_system_prompt()` | 376-442 | 67 | message.rs ë˜ëŠ” ì‹ ê·œ prompt.rs |
| `check_latest_version()` | 446-461 | 16 | mod.rs ë˜ëŠ” storage.rs |
| `version_is_newer()` | 464-471 | 8 | mod.rs ë˜ëŠ” storage.rs |
| `models` ë¡œë”© (load_bot_settings) | 573-584 | 12 | storage.rs |
| `models`, `debug` ì €ì¥ | 606-607, 614-617 | 6 | storage.rs |
| debug ë³µì› (run_bot) | 683-687 | 5 | mod.rs |
| `/model` bot command ë“±ë¡ | 702 | 1 | mod.rs |
| `pending_schedules` ì´ˆê¸°í™” | 724 | 1 | mod.rs |
| scheduler ë©”ì‹œì§€ + spawn | 728, 755-758 | 5 | mod.rs |
| startup greeting | 731-750 | 20 | mod.rs |
| scheduler_handle.abort() | 771 | 1 | mod.rs |
| `/help` Schedule + /model ì„¹ì…˜ | 1050-1072 | 22 | commands.rs |
| `/start` HTML ë Œë”ë§ + ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒíŠ¸ | 1168-1196 | 28 | commands.rs |
| `build_history_preview()` | 1200-1235 | 36 | commands.rs |
| `is_workspace_id()` | 1238-1240 | 3 | commands.rs ë˜ëŠ” message.rs |
| `handle_workspace_resume()` | 1243-1323 | 81 | commands.rs |
| `/clear` ê²½ë¡œ ìŠ¤ìº” ì‚­ì œ ë°©ì‹ | 1326-1390 | 65 | commands.rs |
| `/pwd` ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íŒíŠ¸ | 1407-1418 | 12 | commands.rs |
| ì…¸ UI ì˜ì–´ + HTML | 1720, 1856-1893 ë“± | ~30 | file_ops.rs |
| `/model` ë¼ìš°íŒ… | 979-981 | 3 | message.rs |
| workspace ID ë¼ìš°íŒ… | 988-991 | 4 | message.rs |
| `handle_debug_command` token ë§¤ê°œë³€ìˆ˜ | 2056-2076 | 21 | commands.rs |
| `resolve_model_name()` | 2243-2249 | 7 | tools.rs ë˜ëŠ” commands.rs |
| `display_model_name()` | 2252-2254 | 3 | tools.rs ë˜ëŠ” commands.rs |
| `handle_model_command()` | 2257-2328 | 72 | commands.rs |
| ëª¨ë¸ ì¶”ì¶œ + `build_system_prompt` í˜¸ì¶œ | 2380-2440 | 60 | message.rs |
| cokacdir ê´€ë ¨ ë³€ìˆ˜/ì²˜ë¦¬ | 2503-2543 | 40 | message.rs |
| `detect_cokacdir_command()` | 3318-3332 | 15 | tools.rs |
| `read_latest_cron_result()` | 3334-3347 | 14 | tools.rs |
| `format_cokacdir_result()` | 3348-3418 | 71 | tools.rs |
| `format_bash_command()` | 3419-3431 | 13 | tools.rs |
| `should_trigger()` | 3595-3633 | 39 | schedule.rs |
| `update_schedule_after_run()` | 3634-3667 | 34 | schedule.rs |
| `execute_schedule()` | 3668-4118 | 451 | schedule.rs |
| `scheduler_loop()` | 4119-4222 | 104 | schedule.rs |

**ì´ í•©ê³„: ~1,450ì¤„ ì´ìƒ (ì „ì²´ íŒŒì¼ì˜ ì•½ 34%)**

---

## 7. ê²°ë¡ 

### PRì˜ ì¥ì 
- ëª¨ë“ˆ ë¶„ë¦¬ êµ¬ì¡° ì„¤ê³„ê°€ ì ì ˆí•˜ê³  ê¸°ëŠ¥ë³„ ì±…ì„ ë¶„ë¦¬ê°€ ì˜ ë˜ì–´ ìˆìŒ
- `cleanup_stale_sessions()`ì™€ `delete_session_file()` ì‹ ê·œ ê¸°ëŠ¥ì´ ìœ ìš©í•¨
- `pub(crate)` ê°€ì‹œì„±ê³¼ `$crate::` ë§¤í¬ë¡œ ê²½ë¡œ ì²˜ë¦¬ê°€ ì˜¬ë°”ë¦„
- `streaming.rs`, `tools.rs`ëŠ” í˜„ì¬ mainê³¼ 100% í˜¸í™˜

### ì ìš©ì˜ í˜„ì‹¤ì  ì–´ë ¤ì›€
- Mainì´ PR ë² ì´ìŠ¤ ëŒ€ë¹„ **53% ì„±ì¥** (2,753 â†’ 4,222ì¤„)
- **~1,450ì¤„**ì˜ ì‹ ê·œ ì½”ë“œê°€ PRì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ
- 7ê°œ **ì»´íŒŒì¼ ë¶ˆê°€ ìˆ˜ì¤€** ì¶©ëŒê³¼ 10ê°œ **ë™ì‘ ì°¨ì´** ì¶©ëŒ ì¡´ì¬
- PR ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì ìš© í›„ ëˆ„ë½ ê¸°ëŠ¥ì„ íŒ¨ì¹˜í•˜ëŠ” ê²ƒì€ ì‚¬ì‹¤ìƒ ì „ì²´ ì¬ì‘ì„±ê³¼ ë™ì¼í•œ ì‘ì—…ëŸ‰
